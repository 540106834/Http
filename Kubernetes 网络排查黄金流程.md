ä¸‹é¢ç»™ä½ ä¸€ä»½ **æœ€å®ç”¨ã€æœ€æ¸…æ™°ã€å¯ç›´æ¥ç”¨äºç”Ÿäº§çš„ Kubernetes ç½‘ç»œæ’æŸ¥é»„é‡‘æµç¨‹ï¼ˆSOP æ–‡æ¡£ç‰ˆï¼‰**ã€‚
æ¶µç›–ï¼šDNS â†’ Service â†’ Endpoint â†’ Pod â†’ Node â†’ CNI â†’ å¤–ç½‘ï¼Œå®Œå…¨å¯ä½œä¸ºå†…éƒ¨æ–‡æ¡£ä½¿ç”¨ã€‚

---

# ğŸŸ¦ **Kubernetes ç½‘ç»œæ’æŸ¥é»„é‡‘æµç¨‹ï¼ˆSOPï¼‰**

> ç›®æ ‡ï¼šå¿«é€Ÿå®šä½ **è®¿é—®å¤±è´¥ / è¶…æ—¶ / ä¸ç¨³å®š / DNS ä¸é€š / ç«¯å£ä¸é€š** ç­‰é—®é¢˜ã€‚
> é€‚ç”¨å¯¹è±¡ï¼šå¼€å‘ã€SREã€è¿ç»´ã€å®¹å™¨å¹³å°å›¢é˜Ÿã€‚

---

# ğŸ”µ **æ€»è§ˆæµç¨‹å›¾**

```
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ 1. DNSè§£æ     â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
             â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ 2. Service     â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
             â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ 3. Endpoint    â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
             â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ 4. Pod ç½‘ç»œ    â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
             â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ 5. Node ç½‘ç»œ   â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
             â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ 6. CNI å±‚      â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
             â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ 7. å‡ºå£/Ingressâ”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# ğŸŸ© **Step 1ï¼šDNS è§£ææ˜¯å¦æ­£å¸¸**

### ğŸ€ 1.1 é›†ç¾¤å†…éƒ¨è§£ææœåŠ¡åŸŸå

```bash
kubectl exec -it <pod> -- nslookup mysvc.default.svc.cluster.local
```

### ğŸ€ 1.2 è‹¥è§£æå¤±è´¥ â†’ æµ‹è¯• CoreDNS

```bash
kubectl exec -it <pod> -- nc -zv <coredns-ip> 53
```

#### ğŸ“Œ è¯Šæ–­ï¼š

* âŒ ä¸é€š â†’ CoreDNS å®•æœº / Node æ— æ³•è®¿é—® 53 / NetworkPolicy é˜»æ–­
* âœ” é€šï¼Œä½†è§£æå¤±è´¥ â†’ CoreDNS é…ç½®é”™è¯¯ï¼ˆä¸Šæ¸¸ DNSã€forwardã€loop ç­‰ï¼‰

---

# ğŸŸ© **Step 2ï¼šService æ˜¯å¦æ­£å¸¸**

### ğŸ€ 2.1 æŸ¥çœ‹ Service å®šä¹‰

```bash
kubectl get svc mysvc -o wide
```

å…³é”®æ£€æŸ¥ï¼š

* clusterIP
* port
* targetPort
* selector

### ğŸ€ 2.2 æŸ¥çœ‹æ˜¯å¦å­˜åœ¨ endpoints

```bash
kubectl get endpoints mysvc
```

âŒ è‹¥ **ENDPOINTS: <none>** â†’ selector ä¸åŒ¹é… Pod æ ‡ç­¾
âœ” æœ‰ IP â†’ è¿›å…¥ä¸‹ä¸€æ­¥

---

# ğŸŸ© **Step 3ï¼šService åˆ°åç«¯ Pod çš„ç«¯å£æ˜¯å¦é€š**

### ğŸ€ 3.1 ä½¿ç”¨ nc æµ‹è¯• Service åˆ° Pod

```bash
kubectl exec -it <pod> -- nc -zv mysvc 8080
```

#### è¯Šæ–­ï¼š

* âŒ Connection refused â†’ Pod æ²¡ç›‘å¬ targetPort
* âŒ Timeout â†’ ç½‘ç»œä¸é€šï¼ˆCNIã€iptablesã€IPVSï¼‰

---

# ğŸŸ© **Step 4ï¼šPod æœ¬èº«æ˜¯å¦ç›‘å¬ç«¯å£**

### ğŸ€ 4.1 æŸ¥çœ‹å®¹å™¨ç›‘å¬æƒ…å†µ

```bash
kubectl exec -it <pod> -- netstat -ntlp
```

### ğŸ€ 4.2 Pod å†…ç›´æ¥ curlï¼ˆéªŒè¯åº”ç”¨æ­£å¸¸ï¼‰

```bash
kubectl exec -it <pod> -- curl -v http://localhost:8080/health
```

#### è¯Šæ–­ï¼š

* âŒ localhost ä¸é€š â†’ åº”ç”¨å¯åŠ¨å¤±è´¥
* âŒ è¶…æ—¶ â†’ ä»£ç é—®é¢˜ / çº¿ç¨‹æ± ä¸è¶³
* âœ” æ­£å¸¸ â†’ Service/ç½‘ç»œé—®é¢˜

---

# ğŸŸ© **Step 5ï¼šNode åˆ° Pod ç½‘ç»œæ’æŸ¥ï¼ˆNodePort åœºæ™¯å¿…æŸ¥ï¼‰**

### ğŸ€ 5.1 ä» Node æµ‹è¯•å®¹å™¨ç½‘ç»œï¼ˆé‡è¦ï¼‰

```bash
curl http://<pod-ip>:8080
```

### ğŸ€ 5.2 Node åˆ° Pod ç«¯å£æµ‹è¯•

```bash
nc -zv <pod-ip> 8080
```

#### è¯Šæ–­ï¼š

* âŒ Node â†’ Pod ä¸é€šï¼š
  â†’ CNI è·¯ç”± / flannel vxlan / calico BGP / iptables NAT é—®é¢˜

---

# ğŸŸ© **Step 6ï¼šCNI å±‚æ’æŸ¥**

### ğŸ€ 6.1 æŸ¥çœ‹ CNI Pod æ˜¯å¦æ­£å¸¸

```bash
kubectl get pods -n kube-system | grep -E "coredns|calico|flannel|cni"
```

### ğŸ€ 6.2 æŸ¥çœ‹èŠ‚ç‚¹è·¯ç”±æ˜¯å¦æœ‰ Pod ç½‘ç»œæ®µ

```bash
ip route
```

é”™è¯¯ç¤ºä¾‹ï¼ˆå¸¸è§ï¼‰ï¼š

```
10.244.2.0/24 dev flannel.1  scope link  linkdown
```

â†’ ç½‘å¡æŒ‚äº† â†’ é‡å¯ flannel/calico

---

# ğŸŸ© **Step 7ï¼šå‡ºå£ç½‘ç»œï¼ˆå¤–ç½‘è®¿é—®å¤±è´¥ï¼‰**

### ğŸ€ 7.1 ä» Pod è®¿é—®å¤–ç½‘

```bash
kubectl exec -it <pod> -- curl -I https://www.google.com
```

### ğŸ€ 7.2 è‹¥è¶…æ—¶ï¼Œç”¨ nc çœ‹ TCP æ˜¯å¦é€š

```bash
kubectl exec -it <pod> -- nc -zv www.google.com 443
```

#### è¯Šæ–­ï¼š

* nc é€š â†’ è¯ä¹¦é—®é¢˜ / curl è¯ä¹¦é”™è¯¯
* nc ä¸é€š â†’ å‡ºå£ NAT / Egress æ§åˆ¶ / é˜²ç«å¢™

### ğŸ€ 7.3 æ£€æŸ¥ Node æ˜¯å¦å¯ä»¥è®¿é—®å¤–ç½‘

```bash
curl -I https://www.google.com
```

Node é€šï¼ŒPod ä¸é€š â†’ SNATï¼ˆMASQUERADEï¼‰ä¸¢å¤±ã€‚

---

# ğŸŸ¦ **é™„å½•ï¼šæœ€å¸¸ç”¨å¿«é€Ÿæ’æŸ¥å‘½ä»¤åˆé›†**

### âœ” æµ‹ DNS

```
nslookup mysvc
dig mysvc
```

### âœ” æµ‹ Service

```
nc -zv mysvc 8080
kubectl get endpoints mysvc
```

### âœ” æµ‹ Pod

```
curl http://<pod-ip>:8080
kubectl exec ... curl localhost
```

### âœ” æµ‹ Node

```
nc -zv <pod-ip> 8080
```

### âœ” æµ‹å¤–ç½‘

```
nc -zv www.google.com 443
```

---

# ğŸŸª éœ€è¦æˆ‘å¸®åŠ©ä½ æŠŠè¿™ä»½ **SOP åšæˆå¯ä¸‹è½½çš„ PDF / Word / PPT** å—ï¼Ÿ

ä½ å¯ä»¥ç›´æ¥æ‹¿å»ç»™å›¢é˜Ÿä½¿ç”¨ã€‚
