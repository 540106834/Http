# **可用于生产环境的网络排错详解**
包含从最底层到应用层的系统化排查步骤、常见问题、判断方法、命令示例和案例分析。
这是网络工程师、SRE、DevOps 都在用的完整思路。


#  一、网络排错黄金原则（最重要的三句话）

1. **从下往上，不要乱跳层**
   物理 → 链路层 → 网络层 → 传输层 → 应用层
2. **永远只检查一层，不要同时检查两层**
   避免方向混乱。
3. **每一步都必须明确：现在是通还是不通**
   用结果驱动下一步，而不是凭感觉。

---

#  二、网络排错五层模型（逐层排查）

下面是从最底层到最高层的排查顺序。

---

# **① 物理层（第 1 层） — 最基础的问题**

检查题：**线有没有？设备有没有？亮灯有没有？**

### 排查点

* 网线断、松
* 光纤坏
* 服务器网卡坏
* Switch 端口未启用
* 速率/双工不匹配（常见）

### 排查命令

**Linux**

```
ethtool eth0
ip link show
```

**常见问题特征**

* 网卡 `DOWN`
* RX/TX 有错误包
* 线未插好
* “卡顿但不完全断” → 很可能双工不一致

---

# **② 数据链路层（第 2 层）— MAC、ARP、交换机**

检查：**ARP 是否正常？能否找到对方 MAC？**

### 功能：

* 在同一网段内找到对方 MAC 地址
* 发送广播 ARP 请求 → 收到 ARP 回复

### 排查命令：

```
arp -a
ip neigh
```

正常应该看到：

```
192.168.1.10 dev eth0 lladdr 00:16:3e:ab:cd:ef REACHABLE
```

### 常见故障：

* ARP 缓存过期
* ARP 被安全策略过滤
* 对端机器掉线
* Switch VLAN 配置错
* 机器 IP 冲突

### 快速判断：

* **可以 ping 网关但 ping 不同网段不行 → 路由问题（到 3 层排查）**
* **同网段也 ping 不通 → 基本是链路层问题**

---

# **③ 网络层（第 3 层）— IP、路由、PING、掩码**

这里最关键的命令：**ping、traceroute、route、ip addr、ip route**

### 判断方法

1. **ping 自己 IP**

```
ping 192.168.1.100
```

通 → 网卡正常
不通 → 本机 IP 配置错误或网卡问题

2. **ping 网关**

```
ping 192.168.1.1
```

不通 → 很可能是三类问题：

* ARP 没拿到网关 MAC（回到第 2 层）
* VLAN 错
* 网关本身挂了

3. **traceroute 路由跳转**

```
traceroute 8.8.8.8
```

### 常见问题

* 掩码错误导致无法进入正确网段
* 默认路由缺失导致出不了网
* 路由冲突
* VPN/内网路由覆盖
* 服务器设置了静态路由，导致返回路径不一致（很常见）

---

# **④ 传输层（第 4 层）— TCP / UDP 排错**

### 工具：

* **tcpdump**
* **telnet / nc**
* **ss / netstat**
* **curl -I**

### 判断 TCP 是否连得上

```
telnet 10.0.0.10 8080
# 或
nc -zv 10.0.0.10 8080
```

结果：

* **Connected** → TCP 成功建立连接
* **Connection refused** → 对端端口没监听（应用层问题）
* **Connection timed out** → 网络不通 / 防火墙问题

### 检查端口是否监听

```
ss -lntp
```

### 常见问题

* 本地没有 `LISTEN`，应用没启动
* 对端防火墙拒绝（iptables、security group）
* 云厂商安全组没放行端口
* 服务监听在 `127.0.0.1` 而不是 `0.0.0.0`

---

# **⑤ 应用层（第 7 层）— HTTP / API / 服务自身问题**

### 工具

* curl
* 浏览器开发者工具
* 日志（应用日志最关键）

### 检查方式

**1. API 是否返回 200？**

```
curl -i http://localhost:8080/api/users
```

**2. 日志报错？**

* DB 连不上
* 程序异常
* JSON 格式错误
* 上游依赖未启动

**3. 程序假死，但端口还在监听**

* 常见于 Java、Node、Python
* 用 `top`、`jstat`、`jstack`查死锁或内存耗尽

---

#  三、一个真实的网络排错案例（非常典型）

## 情况：

`curl http://10.0.0.20:8080` 超时
你怀疑是服务挂了，但不知道是哪一层的问题。

---

## **① 测试网络层（Ping）**

```
ping 10.0.0.20
```

通 → 网络没问题，继续下一层
不通 → 回到链路层检查 ARP/VLAN

---

## **② 测试传输层（TCP 端口）**

```
nc -zv 10.0.0.20 8080
```

结果：
 **Connection refused**

解释：
网络能到对方机器 → 但对方 8080 端口没人监听 → 应用没启动

---

## **③ 检查对端监听端口**

登录 10.0.0.20：

```
ss -lntp | grep 8080
```

没输出 → 服务没启动

---

## **④ 检查应用日志**

```
tail -f app.log
```

发现：数据库连接失败，程序退出。

---

##  最终根因

**数据库密码配置错 → 应用启动失败 → 8080 没监听 → curl 超时**

---

#  四、生产环境网络排错流程图（非常实用）

**按照这个顺序排查永远不会乱：**

```
① 物理层 → ② ARP/链路层 → ③ IP/路由层 → ④ TCP 端口 → ⑤ 应用层
```

每层只做一件事，让问题被快速定位。

---

#  五、我可以继续帮你做的内容

我可以为你生成：

✅ 更详细的 **网络排错 SOP 文档（企业版）**
✅ 每一层的 **命令合集**
✅ 网络排错 **速查表（Cheat Sheet）**
✅ **排错案例：K8s、容器、云主机、微服务场景**
✅ 一张可视化的 **网络排错流程图**（非常直观）

你想让我继续哪个？
