

#  **四层代理两条 TCP 连接的建立顺序（完整顺序图）**

**L4 Proxy = 转发 TCP，不解析内容**

因此，四层代理一定会出现两条 TCP 连接：

---

# **Ⅰ. 客户端 → 代理 的 TCP 连接（上游连接）**

顺序如下：

1. **Client → Proxy：SYN**
2. **Proxy → Client：SYN/ACK**
3. **Client → Proxy：ACK**

🔹到这里，**四层代理已经和客户端建立好连接**
🔹但此时 **L4 Proxy 还没有和后端服务器建立连接**

为什么？
→ 因为 L4 代理通常要等客户端发来第一个数据包（比如 HTTP 请求的第一个字节）之后，才会知道：

* 要使用哪个后端池
* 某些需要 SNI、端口、多路复用信息
* 负载均衡算法挑选哪个后端

---

# **Ⅱ. 代理 → 后端服务器 的 TCP 连接（下游连接）**

通常发生在代理收到客户端的第一个数据 payload 后：

1. **Proxy → Server：SYN**
2. **Server → Proxy：SYN/ACK**
3. **Proxy → Server：ACK**

🔹到这里，**代理和后端也建立好了 TCP 连接**
🔹代理开始转发数据：

* 客户端 → 代理 → 服务端
* 服务端 → 代理 → 客户端

---

#  **完整时序图**

```
Client                     Proxy                     Server
  | --- SYN ------------->  |                          
  | <-- SYN/ACK ----------  |                          
  | --- ACK ------------->  |   （上游连接建立完成）     

  | --- Data -------------> |                          
  |                         | --- SYN ----------------> |
  |                         | <-- SYN/ACK -------------|
  |                         | --- ACK ----------------> | （下游连接建立完成）

  | <------ Data (from server) ----------------------- |
```

---

#  一句话总结

### **四层代理一定是“先与客户端建链，再与后端建链”。**

顺序永远是：

1. **上游 TCP（client→proxy）三次握手**
2. **收到客户端第一个数据包**
3. **下游 TCP（proxy→server）三次握手**
4. **开始双向转发数据**

---

#  为什么不提前连接后端？

因为 L4 代理没有能力毫无上下文地提前知道：

* 该请求要发给哪个后端
* 该使用哪个 LB pool
* 是否会话保持
* 是否需要根据 SNI/源端口/五元组选择后端

它只转发 TCP，不解析上层协议，因此只能 **看到客户端数据后** 才能决定。

---

#  特殊情况（可选）

某些高性能 L4 LB（例如 HAProxy、Envoy）可开启：

* **TCP pre-connect**（提前建后端连接池）
* **connection reuse**
* **connection pooling**

 但默认情况下，即你问的“标准四层代理”，连接顺序永远是上面那一套。

---

如果你需要，我可以继续帮你：

* 画更细节的数据包图（含端口）
* 对比 L7 代理的 TCP 建链顺序
* 解释为什么 L7 代理会导致你之前遇到的断点问题

要继续吗？
